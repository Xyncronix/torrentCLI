#!/usr/bin/python3
import requests
import json
import sys
import subprocess

class bg:
    PINK = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    RED = '\033[91m'
    NORM = '\033[0m'

def main():
    if len(sys.argv) == 1:
        sys.exit("Please rerun the command in the format: \n ~ $ torrentcli movie name")
    args = sys.argv[1:]
    search = ("+".join(args)).replace(" ", "+")
    site = "librex.beparanoid.de"
    url = f"https://{site}/api.php?q={search}&p=0&type=3"
    data = requests.get(url=url).json()

    print(args, "\n", search, "\n", site, "\n", url, "\n")

    numberOfOutputs = 8

    def output(a):
        for i in range(a):
            torrent = data[i]
            if torrent["seeders"] != 0:
                name = str(torrent['name'])
                seeders = str(torrent['seeders'])
                leechers = str(torrent['leechers'])
                size = str(torrent['size'])
                source = str(torrent['source'])
                print(f"[{i + 1}]{bg.RED} {name} {bg.GREEN} {seeders} {bg.PINK} {leechers} {bg.BLUE} {size} {bg.YELLOW} {source} {bg.NORM}" )

    if len(data) < numberOfOutputs:
        a = len(data)
    else: 
        a = numberOfOutputs
    output(a)

    try:
        x = int(input("Which torrent would you like? "))
    except ValueError:
        print("Please enter a number between 1 and ")

    if "1337x" in data[x]['source']:
        re = requests.get(f"https://{site}/{data[x]['magnet']}")
        magnet = re.headers[('location'.casefold())]
    else:
        magnet = data[x-1]["magnet"]
    subprocess.run(["xdg-open", magnet])
try:
    main()
except KeyboardInterrupt:
    print("Exiting...")
